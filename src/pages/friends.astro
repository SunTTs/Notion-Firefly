---
import { getEntry, render } from "astro:content";
import Comment from "@components/comment/index.astro";
import Markdown from "@components/common/Markdown.astro";
import { Icon } from "astro-icon/components";
import { friendsPageConfig, getEnabledFriends } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";

const friendsPost = await getEntry("spec", "friends");

if (!friendsPost) {
	throw new Error("friends page content not found");
}

const { Content } = await render(friendsPost);

// 使用配置文件中的友链数据，按权重排序
const items = getEnabledFriends();
const allTags = [...new Set(items.flatMap((item) => item.tags || []))].sort();

// 页面标题和描述
const title = friendsPageConfig.title || i18n(I18nKey.friends);
const description =
	friendsPageConfig.description || i18n(I18nKey.friendsDescription);
---

<MainGridLayout title={title} description={description}>
  <div
    class="flex w-full rounded-(--radius-large) overflow-hidden relative min-h-32"
  >
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- 页面标题和描述 -->
      <div class="mb-4">
        <div class="flex items-center gap-3 mb-3">
          <div
            class="h-8 w-8 rounded-lg bg-(--primary) flex items-center justify-center text-white dark:text-black/70"
          >
            <Icon name="material-symbols:group" class="text-[1.5rem]" />
          </div>
          <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
            {title}
          </h1>
        </div>
        {
          description && (
            <p class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed mb-4">
              {description}
            </p>
          )
        }
      </div>

      <!-- 标签筛选 -->
      {
        items.length > 0 && (
          <friend-filter class="flex flex-wrap gap-2 mb-6">
            <button
              data-tag="all"
              class="btn-regular px-3 py-1.5 rounded-lg bg-(--primary) text-white hover:bg-(--primary) transition-colors duration-200 text-sm font-medium"
            >
              {i18n(I18nKey.all)}
            </button>
            {allTags.map((tag) => (
              <button
                data-tag={tag}
                class="btn-regular px-3 py-1.5 rounded-lg bg-(--btn-regular-bg) text-(--btn-content) hover:bg-(--btn-regular-bg-hover) transition-colors duration-200 text-sm font-medium"
              >
                {tag}
              </button>
            ))}
          </friend-filter>
        )
      }

      <div class="friends-grid my-4">
        {
          items.map((item) => (
            <a
              href={item.siteurl}
              target="_blank"
              rel="noopener noreferrer"
              data-tags={item.tags?.join(",")}
              class="friend-card group flex items-center gap-3 p-2.5 rounded-xl border border-(--line-divider) hover:border-(--primary) hover:bg-(--card-bg) transition-all duration-300 hover:shadow-lg relative overflow-hidden"
            >
              {/* 背景装饰 - 仅悬停显示 */}
              <div class="absolute inset-0 bg-(--primary) opacity-0 group-hover:opacity-5 transition-opacity duration-300 pointer-events-none" />

              {/* 头像 */}
              <div class="relative w-16 h-16 shrink-0 rounded-xl overflow-hidden bg-zinc-100 dark:bg-zinc-800 border border-black/5 dark:border-white/5 group-hover:scale-105 transition-transform duration-300">
                <img
                  src={item.imgurl}
                  alt={item.title}
                  class="w-full h-full object-cover"
                />
              </div>

              {/* 内容 */}
              <div class="grow min-w-0 flex flex-col justify-center gap-0.5">
                <div class="flex items-center justify-between">
                  <div class="font-bold text-base text-neutral-900 dark:text-neutral-100 group-hover:text-(--primary) transition-colors truncate pr-4">
                    {item.title}
                  </div>
                  {/* 外部链接图标 */}
                  <Icon
                    name="material-symbols:arrow-outward-rounded"
                    class="text-(--primary) text-lg opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300"
                  />
                </div>

                <div
                  class="text-sm text-neutral-500 dark:text-neutral-400 line-clamp-1"
                  title={item.desc}
                >
                  {item.desc}
                </div>

                {/* 标签 */}
                <div class="flex flex-wrap gap-1 mt-1">
                  {item.tags && item.tags.length > 0
                    ? item.tags
                        .slice(0, 3)
                        .map((tag) => (
                          <span class="text-[0.65rem] px-1.5 py-0.5 rounded bg-neutral-100 dark:bg-neutral-800 text-neutral-500 dark:text-neutral-400 transition-colors duration-300">
                            {tag}
                          </span>
                        ))
                    : null}
                </div>
              </div>
            </a>
          ))
        }
      </div>
    </div>
  </div>

  {friendsPageConfig.showCustomContent !== false && (
    <div class="mt-4 card-base z-10 px-9 py-6 relative w-full">
      <Markdown class="">
        <Content />
      </Markdown>
    </div>
  )}

  <!-- 友链提交表单 -->
  {friendsPageConfig.showSubmitForm && (
  <div class="mt-4">
    <div class="card-base px-9 py-6 rounded-xl">
      <h2 class="text-2xl font-bold mb-4 text-neutral-900 dark:text-neutral-100">
        申请友链
      </h2>
      <p class="text-neutral-600 dark:text-neutral-400 mb-6">
        请填写您的友链信息，我会在审核通过后添加到友链列表中。
      </p>
      
      <form id="friendForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="title" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
              您的站点名称
              <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="title"
              name="title"
              required
              class="w-full px-3 py-2 border border-(--line-divider) rounded-lg focus:outline-none focus:ring-2 focus:ring-(--primary) focus:border-transparent text-neutral-600 dark:text-neutral-400 placeholder:text-neutral-400 dark:placeholder:text-neutral-600"
              placeholder="请输入您的站点名称"
            />
          </div>
          <div>
            <label for="siteurl" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
              您的站点URL
              <span class="text-red-500">*</span>
            </label>
            <input
              type="url"
              id="siteurl"
              name="siteurl"
              required
              class="w-full px-3 py-2 border border-(--line-divider) rounded-lg focus:outline-none focus:ring-2 focus:ring-(--primary) focus:border-transparent text-neutral-600 dark:text-neutral-400 placeholder:text-neutral-400 dark:placeholder:text-neutral-600"
              placeholder="请输入您的站点URL"
            />
          </div>
        </div>
        
        <div>
          <label for="imgurl" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
            您的站点头像URL
            <span class="text-red-500">*</span>
          </label>
          <input
            type="url"
            id="imgurl"
            name="imgurl"
            required
            class="w-full px-3 py-2 border border-(--line-divider) rounded-lg focus:outline-none focus:ring-2 focus:ring-(--primary) focus:border-transparent text-neutral-600 dark:text-neutral-400 placeholder:text-neutral-400 dark:placeholder:text-neutral-600"
            placeholder="请输入您的站点头像URL"
          />
        </div>
        
        <div>
          <label for="desc" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
            您的站点描述
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="desc"
            name="desc"
            required
            class="w-full px-3 py-2 border border-(--line-divider) rounded-lg focus:outline-none focus:ring-2 focus:ring-(--primary) focus:border-transparent text-neutral-600 dark:text-neutral-400 placeholder:text-neutral-400 dark:placeholder:text-neutral-600"
            placeholder="请输入您的站点描述"
          />
        </div>
        
        <button
          id="submitLinkBtn"
          type="submit"
          class="w-full bg-(--primary) text-white transition-colors duration-300 py-3 px-4 text-medium rounded-lg cursor-pointer hover:bg-(--btn-regular-bg-hover)"
        >
          提交申请
        </button>
      </form>
      
      <div id="formMessage" class="mt-4 hidden p-4 rounded-lg"></div>
    </div>
  </div>
  )}

  <!-- 评论区 -->
  <div class="mt-4">
    <Comment post={friendsPost} customPath="/friends/" />
  </div>

  <script slot="head" is:inline>
    if (!customElements.get("friend-filter")) {
      class FriendFilter extends HTMLElement {
        constructor() {
          super();
        }

        connectedCallback() {
          this.addEventListener("click", this.handleClick);
        }

        disconnectedCallback() {
          this.removeEventListener("click", this.handleClick);
        }

        handleClick(e) {
          const target = e.target;
          const button = target.closest("button");
          if (!button) return;

          const selectedTag = button.dataset.tag;
          const filters = this.querySelectorAll("button");
          const container = this.closest(".card-base");
          if (!container) return;

          const cards = container.querySelectorAll(".friend-card");

          filters.forEach((f) => {
            f.classList.remove("bg-(--primary)", "text-white");
            f.classList.remove("hover:bg-(--primary)");
            f.classList.add(
              "bg-(--btn-regular-bg)",
              "text-(--btn-content)"
            );
            f.classList.add("hover:bg-(--btn-regular-bg-hover)");

            if (f === button) {
              f.classList.remove(
                "bg-(--btn-regular-bg)",
                "text-(--btn-content)"
              );
              f.classList.remove("hover:bg-(--btn-regular-bg-hover)");
              f.classList.add("bg-(--primary)", "text-white");
              f.classList.add("hover:bg-(--primary)");
            }
          });

          cards.forEach((card) => {
            const cardEl = card;
            const tags = (cardEl.dataset.tags || "").split(",");
            if (
              selectedTag === "all" ||
              (selectedTag && tags.includes(selectedTag))
            ) {
              cardEl.style.display = "";
              cardEl.classList.add("animate-fade-in-up");
            } else {
              cardEl.style.display = "none";
              cardEl.classList.remove("animate-fade-in-up");
            }
          });
        }
      }
      customElements.define("friend-filter", FriendFilter);
    }
  </script>

  <style is:global>
    .friends-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 0.75rem;
    }
  </style>

  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('friendForm');
      const messageDiv = document.getElementById('formMessage');
      const submitButton = document.getElementById('submitLinkBtn');
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // 禁用提交按钮，添加冷却效果
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.style.cursor = 'not-allowed';
          submitButton.textContent = '提交中...';
        }
        
        const formData = new FormData(form);
        const data = {
          title: formData.get('title'),
          siteurl: formData.get('siteurl'),
          imgurl: formData.get('imgurl'),
          desc: formData.get('desc'),
        };
        
        try {
          const response = await fetch('/api/submit-links/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });
          
          const result = await response.json();
          
          if (response.ok && result.success) {
            messageDiv.textContent = result.message || '友链申请提交成功！我会尽快处理并添加。';
            messageDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
            form.reset();
          } else {
            messageDiv.textContent = result.message || '提交失败，请稍后重试。';
            messageDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
          }
        } catch (error) {
          messageDiv.textContent = '网络错误，请检查连接后重试。';
          messageDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
        } finally {
          submitButton.textContent = '提交申请';
          // 5秒后重新启用提交按钮
          setTimeout(() => {
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.style.cursor = 'pointer';
            }
          }, 5000);
          setTimeout(() => {
            messageDiv.textContent = '';
            messageDiv.className = '';
          }, 10000);
        }
      });
    });
  </script>
</MainGridLayout>
